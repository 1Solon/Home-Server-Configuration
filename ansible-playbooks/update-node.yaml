---
- hosts: all
  become: true
  tasks: 
    # Update apt packages
    - name: update apt packages
      apt:
        update_cache: yes
        upgrade: yes
        cache_valid_time: 3600

     # Check if reboot is required
    - name: check if system reboot is required
      become: false
      stat:
        path: /var/run/reboot-required
      register: reboot_required
    
    # Notify me when a reboot is required
    - name: send ntfy notification
      uri:
        url: "https://ntfy.solonsstuff.com/{{ ntfy_channel }}"
        method: POST
        body: "The system '{{ inventory_hostname }}' needs to be restarted."
        headers: 
          'Authorization': "{{ ntfy_token }}"
          'Title': "Reboot Required"
          'Priority': '3'
          'Tags': 'arrows_counterclockwise'
        return_content: yes
        follow_redirects: all
        use_proxy: no
      # when: reboot_required.stat.exists